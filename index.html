// GASにリクエストを送信する共通関数 (JSONP方式)
        function sendRequest(payload) {
            if (!GAS_WEB_APP_URL) {
                statusMessage.textContent = 'エラー: GASのURLが設定されていません。';
                return;
            }
            statusMessage.innerHTML = '通信中...';
            statusMessage.className = 'status-message text-center text-sm font-medium p-3 rounded-md bg-yellow-100 text-yellow-800';

            const callbackName = 'jsonp_callback_' + Date.now();

            // ▼▼▼ このコールバック関数を修正 ▼▼▼
            window[callbackName] = function(data) {
                // 1. ステータスメッセージを表示
                statusMessage.innerHTML = data.message.replace(/\n/g, '<br>');
                statusMessage.className = 'status-message text-center text-sm font-medium p-3 rounded-md bg-green-100 text-green-800';

                // 2. data.settings が存在する場合、フォームに値を設定する
                if (data.settings) {
                    discordWebhookUrlInput.value = data.settings.webhook || '';
                    ticketIdsInput.value = data.settings.ticket_ids || '';
                    targetEventsInput.value = data.settings.events || '';
                    // GASからnullが返ってくる可能性があるので、その場合は空文字に変換
                    hoursInput.value = data.settings.hours !== null && data.settings.hours !== undefined ? data.settings.hours : '';
                    notifySelect.value = data.settings.notify || 'off';
                }
                
                // 3. 後処理
                document.body.removeChild(document.getElementById(callbackName));
                delete window[callbackName];
            };
            // ▲▲▲ 修正はここまで ▲▲▲

            const params = new URLSearchParams();
            params.append('callback', callbackName);
            for (const key in payload) {
                params.append(key, payload[key]);
            }
            
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = `${GAS_WEB_APP_URL}?${params.toString()}`;
            
            script.onerror = () => {
                statusMessage.textContent = 'エラー: 通信に失敗しました。GASのURLやデプロイ設定を確認してください。';
                statusMessage.className = 'status-message text-center text-sm font-medium p-3 rounded-md bg-red-100 text-red-800';
                delete window[callbackName];
            };

            document.body.appendChild(script);
        }
